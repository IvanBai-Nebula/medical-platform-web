// 默认头像 - 简单的用户图标 (40x40)
export const DEFAULT_AVATAR_40 = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiByeD0iMjAiIGZpbGw9IiM2MzY2RjEiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0xMiAxMkM5LjI0IDEyIDcgOS43NiA3IDdTOS4yNCAyIDEyIDJTMTcgNC4yNCAxNyA3UzE0Ljc2IDEyIDEyIDEyWk0xMiAxNEM5LjMzIDE0IDQgMTUuMzQgNCAyMFYyMkgyMFYyMEMxOS45OTk2IDE1LjM0IDE0LjY2IDEzIDEyIDE0WiIgZmlsbD0id2hpdGUiLz4KPHN2Zz4KPHN2Zz4='

// 默认头像 - 简单的用户图标 (50x50)
export const DEFAULT_AVATAR_50 = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiByeD0iMjUiIGZpbGw9IiM2MzY2RjEiLz4KPHN2ZyB4PSIxMCIgeT0iMTAiIHdpZHRoPSIzMCIgaGVpZ2h0PSIzMCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIj4KPHBhdGggZD0iTTEyIDEyQzkuMjQgMTIgNyA5Ljc2IDcgN1M5LjI0IDIgMTIgMlMxNyA0LjI0IDE3IDdTMTQuNzYgMTIgMTIgMTJaTTEyIDE0QzkuMzMgMTQgNCAxNS4zNCA0IDIwVjIySDIwVjIwQzE5Ljk5OTYgMTUuMzQgMTQuNjYgMTMgMTIgMTRaIiBmaWxsPSJ3aGl0ZSIvPgo8c3ZnPgo8c3ZnPg=='

// 默认知识封面图片 (400x200)
export const DEFAULT_KNOWLEDGE_COVER = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDQwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxkZWZzPgo8bGluZWFyR3JhZGllbnQgaWQ9ImJnR3JhZGllbnQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgo8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojNjM2NkYxO3N0b3Atb3BhY2l0eToxIiAvPgo8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiM3NjRCQTI7c3RvcC1vcGFjaXR5OjEiIC8+CjwvbGluZWFyR3JhZGllbnQ+CjwvZGVmcz4KPHJlY3Qgd2lkdGg9IjQwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9InVybCgjYmdHcmFkaWVudCkiLz4KPHN2ZyB4PSIxNjAiIHk9IjcwIiB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0xOSAzSDVDMy44OSAzIDMgMy44OSAzIDVWMTlDMyAyMC4xIDMuODkgMjEgNSAyMUgxOUMyMC4xIDIxIDIxIDIwLjEgMjEgMTlWNUMyMSAzLjg5IDIwLjEgMyAxOSAzWk0xOSAxOUg1VjVIMTlWMTlaIiBmaWxsPSJ3aGl0ZSIgZmlsbC1vcGFjaXR5PSIwLjgiLz4KPHBhdGggZD0iTTE0IDE3SDdWMTVIMTRWMTdaIiBmaWxsPSJ3aGl0ZSIgZmlsbC1vcGFjaXR5PSIwLjYiLz4KPHBhdGggZD0iTTE3IDEzSDdWMTFIMTdWMTNaIiBmaWxsPSJ3aGl0ZSIgZmlsbC1vcGFjaXR5PSIwLjYiLz4KPHBhdGggZD0iTTE3IDlIN1Y3SDE3VjlaIiBmaWxsPSJ3aGl0ZSIgZmlsbC1vcGFjaXR5PSIwLjYiLz4KPHN2Zz4KPHRleHQgeD0iMjAwIiB5PSIxNDUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsLW9wYWNpdHk9IjAuOCI+6K+t6K+G5a+55LmaPC90ZXh0Pgo8L3N2Zz4='

/**
 * 获取用户头像，如果没有则返回默认头像
 */
export function getUserAvatar(avatar: string | null | undefined, size: 40 | 50 = 40): string {
  const baseUrl = import.meta.env.VITE_API_BASE_URL || ''

  if (avatar) {
    // 排除占位符图片
    if (avatar.includes('via.placeholder.com')) {
      return size === 50 ? DEFAULT_AVATAR_50 : DEFAULT_AVATAR_40
    }

    // 检查是否已经是完整URL或数据URL
    if (avatar.startsWith('http') || avatar.startsWith('data:') || avatar.startsWith('https')) {
      return avatar
    }

    // 相对路径添加基础URL
    return `${baseUrl}${avatar}`
  }

  return size === 50 ? DEFAULT_AVATAR_50 : DEFAULT_AVATAR_40
}

/**
 * 获取知识封面图片，如果没有则返回默认封面
 */
export function getKnowledgeCover(coverImage: string | null | undefined, title?: string): string {
  if (coverImage && !coverImage.includes('via.placeholder.com')) {
    return coverImage
  }

  // 如果有标题，可以创建带标题的SVG
  if (title) {
    return createKnowledgeCoverWithTitle(title)
  }

  return DEFAULT_KNOWLEDGE_COVER
}

/**
 * 创建带标题的知识封面图片
 */
export function createKnowledgeCoverWithTitle(title: string): string {
  // 限制标题长度，避免显示问题
  const displayTitle = title.length > 12 ? `${title.substring(0, 12)}...` : title

  const svg = `
    <svg width="400" height="200" viewBox="0 0 400 200" fill="none" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="bgGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#6366F1;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#764BA2;stop-opacity:1" />
        </linearGradient>
      </defs>
      <rect width="400" height="200" fill="url(#bgGradient)"/>
      <svg x="160" y="60" width="80" height="60" viewBox="0 0 24 24" fill="none">
        <path d="M19 3H5C3.89 3 3 3.89 3 5V19C3 20.1 3.89 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.89 20.1 3 19 3ZM19 19H5V5H19V19Z" fill="white" fill-opacity="0.8"/>
        <path d="M14 17H7V15H14V17Z" fill="white" fill-opacity="0.6"/>
        <path d="M17 13H7V11H17V13Z" fill="white" fill-opacity="0.6"/>
        <path d="M17 9H7V7H17V9Z" fill="white" fill-opacity="0.6"/>
      </svg>
      <text x="200" y="145" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="white" text-anchor="middle" fill-opacity="0.9">${displayTitle}</text>
    </svg>
  `

  return `data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(svg)))}`
}

/**
 * 生成用户头像文字
 */
export function createUserAvatarWithText(text: string, size: 40 | 50 = 40): string {
  const displayText = text.charAt(0).toUpperCase()
  const fontSize = size === 50 ? '20' : '16'

  const svg = `
    <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect width="${size}" height="${size}" rx="${size / 2}" fill="#6366F1"/>
      <text x="${size / 2}" y="${size / 2 + Number.parseInt(fontSize) / 3}" font-family="Arial, sans-serif" font-size="${fontSize}" font-weight="bold" fill="white" text-anchor="middle">${displayText}</text>
    </svg>
  `

  return `data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(svg)))}`
}
